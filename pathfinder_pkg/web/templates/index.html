<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PathfinderBot Navigation</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .container {
            max-width: 1200px;
        }
        #map-container {
            width: 100%;
            height: 480px;
            border: 1px solid #ccc;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
        }
        #map-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        #controls {
            margin-bottom: 20px;
        }
        .joystick-container {
            width: 200px;
            height: 200px;
            position: relative;
            background-color: #f8f9fa;
            border-radius: 50%;
            margin: 0 auto;
            touch-action: none;
        }
        .joystick-handle {
            width: 60px;
            height: 60px;
            background-color: #6c757d;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
        }
        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        .status-indicator {
            padding: 5px 10px;
            border-radius: 10px;
            font-weight: bold;
        }
        .status-indicator.idle { background-color: #f8f9fa; }
        .status-indicator.planning { background-color: #cff4fc; }
        .status-indicator.moving { background-color: #d1e7dd; }
        .status-indicator.paused { background-color: #fff3cd; }
        .status-indicator.succeeded { background-color: #d1e7dd; }
        .status-indicator.failed { background-color: #f8d7da; }
        .status-indicator.cancelled { background-color: #f8d7da; }
        #telemetry {
            font-family: monospace;
            height: 200px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .battery-indicator {
            width: 100%;
            height: 20px;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .battery-level {
            height: 100%;
            background-color: #20c997;
            transition: width 1s;
        }
        .battery-low {
            background-color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">PathfinderBot Navigation</h1>
        
        <div class="row">
            <!-- Map and Status Column -->
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Navigation Map</h5>
                        <div class="status-indicator" id="status-badge">IDLE</div>
                    </div>
                    <div class="card-body">
                        <div id="map-container">
                            <img id="map-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" alt="Map">
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">System Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Battery</h6>
                                <div class="battery-indicator">
                                    <div class="battery-level" id="battery-level" style="width: 80%;"></div>
                                </div>
                                <div id="battery-text">80% (Not Charging)</div>
                            </div>
                            <div class="col-md-6">
                                <h6>Position</h6>
                                <div id="position">X: 0.00, Y: 0.00, θ: 0.00°</div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>Telemetry</h6>
                                <div id="telemetry"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Controls Column -->
            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Manual Controls</h5>
                    </div>
                    <div class="card-body">
                        <div class="joystick-container" id="joystick">
                            <div class="joystick-handle"></div>
                        </div>
                        <div class="mt-2 text-center" id="joystick-status">
                            Linear: 0.00 m/s, Angular: 0.00 rad/s
                        </div>
                        <div class="control-buttons mt-3">
                            <button class="btn btn-danger" id="stop-btn">Stop</button>
                            <button class="btn btn-warning" id="pause-btn">Pause/Resume</button>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Navigation</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="goal-x" class="form-label">Goal X (meters):</label>
                            <input type="number" class="form-control" id="goal-x" value="1.0" step="0.1">
                        </div>
                        <div class="mb-3">
                            <label for="goal-y" class="form-label">Goal Y (meters):</label>
                            <input type="number" class="form-control" id="goal-y" value="1.0" step="0.1">
                        </div>
                        <div class="mb-3">
                            <label for="goal-theta" class="form-label">Goal θ (degrees):</label>
                            <input type="number" class="form-control" id="goal-theta" value="0.0" step="10">
                        </div>
                        <button class="btn btn-primary w-100" id="set-goal-btn">Set Goal</button>
                        <div class="d-flex justify-content-between mt-3">
                            <button class="btn btn-outline-danger w-100" id="cancel-nav-btn">Cancel Navigation</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Connect to Socket.IO server
            const socket = io();
            
            // Element references
            const mapImage = document.getElementById('map-image');
            const statusBadge = document.getElementById('status-badge');
            const batteryLevel = document.getElementById('battery-level');
            const batteryText = document.getElementById('battery-text');
            const positionText = document.getElementById('position');
            const telemetry = document.getElementById('telemetry');
            const joystick = document.getElementById('joystick');
            const joystickHandle = joystick.querySelector('.joystick-handle');
            const joystickStatus = document.getElementById('joystick-status');
            const stopBtn = document.getElementById('stop-btn');
            const pauseBtn = document.getElementById('pause-btn');
            const goalXInput = document.getElementById('goal-x');
            const goalYInput = document.getElementById('goal-y');
            const goalThetaInput = document.getElementById('goal-theta');
            const setGoalBtn = document.getElementById('set-goal-btn');
            const cancelNavBtn = document.getElementById('cancel-nav-btn');
            
            // Status colors
            const statusColors = {
                'IDLE': 'idle',
                'PLANNING': 'planning',
                'MOVING': 'moving',
                'PAUSED': 'paused',
                'SUCCEEDED': 'succeeded',
                'FAILED': 'failed',
                'CANCELLED': 'cancelled'
            };
            
            // Joystick variables
            let joystickActive = false;
            let joystickCenter = { x: 0, y: 0 };
            let joystickPos = { x: 0, y: 0 };
            let maxJoystickDistance = 0;
            let linearVelocity = 0;
            let angularVelocity = 0;
            const MAX_LINEAR_VELOCITY = 0.5;  // m/s
            const MAX_ANGULAR_VELOCITY = 1.0; // rad/s
            
            // Initialize joystick
            function initJoystick() {
                const rect = joystick.getBoundingClientRect();
                joystickCenter = {
                    x: rect.width / 2,
                    y: rect.height / 2
                };
                maxJoystickDistance = rect.width / 2 - 30; // Radius minus half of handle width
                
                // Set initial position
                updateJoystickHandlePosition(joystickCenter.x, joystickCenter.y);
                
                // Event listeners
                joystick.addEventListener('mousedown', startJoystick);
                joystick.addEventListener('touchstart', handleTouchStart);
                
                document.addEventListener('mousemove', moveJoystick);
                document.addEventListener('touchmove', handleTouchMove);
                
                document.addEventListener('mouseup', endJoystick);
                document.addEventListener('touchend', endJoystick);
            }
            
            function handleTouchStart(event) {
                event.preventDefault();
                startJoystick(event.touches[0]);
            }
            
            function handleTouchMove(event) {
                event.preventDefault();
                moveJoystick(event.touches[0]);
            }
            
            function startJoystick(event) {
                joystickActive = true;
                const rect = joystick.getBoundingClientRect();
                moveJoystick({
                    clientX: event.clientX,
                    clientY: event.clientY
                });
            }
            
            function moveJoystick(event) {
                if (!joystickActive) return;
                
                const rect = joystick.getBoundingClientRect();
                let x = event.clientX - rect.left;
                let y = event.clientY - rect.top;
                
                // Calculate distance from center
                const dx = x - joystickCenter.x;
                const dy = y - joystickCenter.y;
                const distance = Math.sqrt(dx*dx + dy*dy);
                
                // Clamp to max distance
                if (distance > maxJoystickDistance) {
                    x = joystickCenter.x + (dx / distance) * maxJoystickDistance;
                    y = joystickCenter.y + (dy / distance) * maxJoystickDistance;
                }
                
                updateJoystickHandlePosition(x, y);
                
                // Calculate velocity
                const normalizedX = (x - joystickCenter.x) / maxJoystickDistance;  // -1 to 1
                const normalizedY = (joystickCenter.y - y) / maxJoystickDistance;  // -1 to 1 (inverted Y)
                
                linearVelocity = normalizedY * MAX_LINEAR_VELOCITY;
                angularVelocity = -normalizedX * MAX_ANGULAR_VELOCITY;
                
                updateJoystickStatus();
                sendVelocityCommand();
            }
            
            function endJoystick() {
                if (!joystickActive) return;
                
                joystickActive = false;
                updateJoystickHandlePosition(joystickCenter.x, joystickCenter.y);
                
                // Reset velocity
                linearVelocity = 0;
                angularVelocity = 0;
                updateJoystickStatus();
                sendVelocityCommand();
            }
            
            function updateJoystickHandlePosition(x, y) {
                joystickHandle.style.left = `${x}px`;
                joystickHandle.style.top = `${y}px`;
                joystickPos = { x, y };
            }
            
            function updateJoystickStatus() {
                joystickStatus.textContent = `Linear: ${linearVelocity.toFixed(2)} m/s, Angular: ${angularVelocity.toFixed(2)} rad/s`;
            }
            
            function sendVelocityCommand() {
                socket.emit('control_command', {
                    command: 'move',
                    params: {
                        linear: linearVelocity,
                        angular: angularVelocity
                    }
                });
            }
            
            // Button event listeners
            stopBtn.addEventListener('click', () => {
                // Stop all motion
                linearVelocity = 0;
                angularVelocity = 0;
                updateJoystickStatus();
                sendVelocityCommand();
            });
            
            pauseBtn.addEventListener('click', () => {
                socket.emit('control_command', {
                    command: 'pause_toggle'
                });
            });
            
            setGoalBtn.addEventListener('click', () => {
                const x = parseFloat(goalXInput.value);
                const y = parseFloat(goalYInput.value);
                const theta = parseFloat(goalThetaInput.value) * (Math.PI / 180);  // Convert to radians
                
                socket.emit('control_command', {
                    command: 'set_goal',
                    params: {
                        x: x,
                        y: y,
                        theta: theta
                    }
                });
                
                log(`Setting goal to (${x.toFixed(2)}, ${y.toFixed(2)}, ${goalThetaInput.value}°)`);
            });
            
            cancelNavBtn.addEventListener('click', () => {
                socket.emit('control_command', {
                    command: 'cancel_navigation'
                });
                log('Navigation cancelled');
            });
            
            // Socket.IO event handlers
            socket.on('connect', () => {
                log('Connected to server');
            });
            
            socket.on('disconnect', () => {
                log('Disconnected from server');
            });
            
            socket.on('status_update', (data) => {
                updateStatus(data);
            });
            
            socket.on('map_update', (data) => {
                updateMap(data);
            });
            
            socket.on('command_response', (data) => {
                if (data.error) {
                    log(`Error: ${data.error}`);
                }
            });
            
            // Update functions
            function updateStatus(data) {
                // Update navigation status
                if (data.navigation && data.navigation.status) {
                    statusBadge.textContent = data.navigation.status;
                    
                    // Update status badge color
                    for (const cls of statusBadge.classList) {
                        if (cls.startsWith('status-indicator-')) {
                            statusBadge.classList.remove(cls);
                        }
                    }
                    statusBadge.className = 'status-indicator ' + (statusColors[data.navigation.status] || 'idle');
                }
                
                // Update battery
                if (data.battery) {
                    const level = data.battery.level;
                    batteryLevel.style.width = `${level}%`;
                    batteryLevel.classList.toggle('battery-low', level < 20);
                    batteryText.textContent = `${level}% (${data.battery.charging ? 'Charging' : 'Not Charging'})`;
                }
                
                // Update position
                if (data.pose) {
                    const degrees = (data.pose.theta * 180 / Math.PI).toFixed(1);
                    positionText.textContent = `X: ${data.pose.x.toFixed(2)}, Y: ${data.pose.y.toFixed(2)}, θ: ${degrees}°`;
                }
            }
            
            function updateMap(data) {
                if (data.image) {
                    mapImage.src = `data:image/png;base64,${data.image}`;
                }
            }
            
            function log(message) {
                const timestamp = new Date().toLocaleTimeString();
                telemetry.innerHTML += `[${timestamp}] ${message}<br>`;
                telemetry.scrollTop = telemetry.scrollHeight;
            }
            
            // Initialize
            initJoystick();
            log('PathfinderBot Navigation Interface initialized');
        });
    </script>
</body>
</html>
